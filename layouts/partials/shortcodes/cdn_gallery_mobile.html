{{/* layouts/shortcodes/cdn_gallery_mobile.html */}} 
{{ $page := .Page }}
{{ $thumbs := $page.Params.thumbs }}
{{ $images := $page.Params.images }}
{{ $thumbsNude := default (slice) $page.Params.thumbs_nude }}
{{ $nudes := default (slice) $page.Params.nudes }}

<!-- --- B·ªô ·∫£nh th∆∞·ªùng --- -->
{{ with $thumbs }}
  {{ if gt (len .) 0 }}
    <h2 class="text-lg font-semibold mt-4 mb-3 text-center text-gray-800">
      B·ªô ·∫£nh th∆∞·ªùng ({{ len . }} ·∫£nh)
    </h2>
    <div id="gallery-normal-{{ $page.File.UniqueID }}" class="grid grid-cols-2 gap-3 px-2">
  {{ $count := len $thumbs }}
  {{ $mid := div $count 2 }}

  {{ range $i, $thumb := $thumbs }}
    {{ $full := cond (lt $i (len $images)) (index $images $i) $thumb }}

    <figure class="overflow-hidden rounded-lg shadow-md bg-white">
      <a href="{{ $full }}" class="block glightbox" data-gallery="gallery-normal-{{ $page.File.UniqueID }}">
        <img 
          src="{{ $thumb }}" 
          data-src="{{ $thumb }}" 
          alt="{{ $page.Title }} - ·∫£nh {{ add $i 1 }}"
          class="lazy-image w-full h-full object-cover transition-transform duration-300 hover:scale-105"
          loading="lazy">
      </a>
    </figure>

    {{/* üß© Ch√®n block qu·∫£ng c√°o full width */}}
    {{ if eq $i $mid }}
      <figure class="col-span-2 overflow-hidden rounded-lg shadow-md bg-white fade-in">
        {{ partial "affiliate_blocks.html" . }}
      </figure>
    {{ end }}
  {{ end }}
</div>

  {{ end }}
{{ end }}

<!-- --- B·ªô nude (·∫©n cho ƒë·∫øn khi unlock) --- -->
{{ with $thumbsNude }}
  {{ if gt (len .) 0 }}
    <div class="text-center mt-10">
      <button id="unlock-nude-btn"
              class="w-11/12 max-w-sm py-4 text-lg font-semibold text-white rounded-3xl bg-gradient-to-r from-pink-600 to-red-600 shadow-lg hover:from-red-600 hover:to-pink-500 transition-transform duration-300 transform active:scale-95">
        üíã M·ªü album nude (xem qu·∫£ng c√°o 10s)
      </button>
    </div>
    
    <style>
      #unlock-nude-btn { animation: glowPulse 2.5s ease-in-out infinite; }
      @keyframes glowPulse {
        0% { box-shadow: 0 0 0 rgba(255, 77, 109, 0.6); }
        50% { box-shadow: 0 0 16px rgba(255, 77, 109, 0.6); }
        100% { box-shadow: 0 0 0 rgba(255, 77, 109, 0.6); }
      }
    </style>

    <!-- ‚úÖ JSON d·ªØ li·ªáu ·∫£nh nude -->
    <script id="nude-data-{{ $page.File.UniqueID }}" type="application/json">
      {
        "thumbs": [
          {{ range $index, $src := $thumbsNude }}
            "{{ $src }}"{{ if lt (add $index 1) (len $thumbsNude) }},{{ end }}
          {{ end }}
        ]
      }
    </script>
  {{ end }}
{{ end }}

<!-- ‚úÖ Khung hi·ªÉn th·ªã album nude -->
<div id="nude-gallery-wrapper" class="px-2"></div>

{{ if and (not $thumbs) (not $thumbsNude) }}
  <p class="text-gray-500 text-center mt-6">Album n√†y ch∆∞a c√≥ ·∫£nh.</p>
{{ end }}

<!-- ‚úÖ Script x·ª≠ l√Ω -->
<script>
document.addEventListener("DOMContentLoaded", function() {

  // ===============================
  // üîì KI·ªÇM TRA TR·∫†NG TH√ÅI UNLOCK SAU KHI XEM QU·∫¢NG C√ÅO
  // ===============================
  const params = new URLSearchParams(window.location.search);
  const isUnlocked = params.get("unlock") === "1";

  if (isUnlocked) {
    const unlockBtn = document.getElementById("unlock-nude-btn");
    if (unlockBtn) unlockBtn.style.display = "none";

    const dataEl = document.querySelector('script[id^="nude-data-"]');
    const wrapper = document.getElementById("nude-gallery-wrapper");

    if (dataEl && wrapper) {
      try {
        const json = JSON.parse(dataEl.textContent);
        if (json && json.thumbs && json.thumbs.length > 0) {
          wrapper.innerHTML = `
            <h2 class="text-lg font-semibold mt-10 mb-3 text-center text-gray-800">
              B·ªô ·∫£nh nude (${json.thumbs.length} ·∫£nh)
            </h2>
            <div class="grid grid-cols-2 gap-3 px-2">
              ${json.thumbs.map(src => `
                <figure class="overflow-hidden rounded-lg shadow-md bg-white">
                  <a href="${src}" class="block glightbox" data-gallery="gallery-nude">
                    <img src="${src}" class="w-full h-full object-cover transition-transform duration-300 hover:scale-105" loading="lazy" alt="·∫¢nh nude">
                  </a>
                </figure>
              `).join("")}
            </div>
          `;
          if (typeof GLightbox !== "undefined") GLightbox({ selector: ".glightbox" });
        } else {
          wrapper.innerHTML = `<p class="text-center text-gray-400 italic mt-4">Album ch∆∞a c√≥ ·∫£nh nude.</p>`;
        }
      } catch (err) {
        console.error("‚ùå L·ªói khi parse d·ªØ li·ªáu nude:", err);
      }
    }
  }

  // ===============================
  // üíã N√öT M·ªû ALBUM NUDE (INTERSTITIAL)
  // ===============================
  const unlockBtn = document.getElementById("unlock-nude-btn");
  if (unlockBtn) {
    unlockBtn.addEventListener("click", function() {
      unlockBtn.disabled = true;
      unlockBtn.innerText = "‚è≥ ƒêang m·ªü qu·∫£ng c√°o...";

      const current = new URL(window.location.href);
      current.searchParams.delete("mobile");

      let redirectUrl = current.pathname + current.search;
      if (!redirectUrl.endsWith("/")) redirectUrl += "/";

      const wrapperUrl = new URL("/ad-wrapper/", window.location.origin);
      wrapperUrl.searchParams.set("redirect", redirectUrl);

      window.location.href = wrapperUrl.href;
    });
  }

  // ===============================
  // üí§ LAZY LOAD ·∫¢NH
  // ===============================
  const lazyImages = document.querySelectorAll("img.lazy-image");
  if ("IntersectionObserver" in window) {
    const observer = new IntersectionObserver((entries, obs) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const img = entry.target;
          const src = img.dataset.src;
          if (src && img.src !== src) img.src = src;
          img.onload = () => {
            img.style.opacity = "1";
            img.style.transition = "opacity 0.4s ease-in";
          };
          obs.unobserve(img);
        }
      });
    }, { rootMargin: "300px 0px", threshold: 0.01 });

    lazyImages.forEach(img => observer.observe(img));
  } else {
    lazyImages.forEach(img => { img.src = img.dataset.src; img.style.opacity = "1"; });
  }

  // ===============================
  // üå∏ FADE-IN CHO BLOCK QU·∫¢NG C√ÅO
  // ===============================
  const fadeEls = document.querySelectorAll(".fade-in");
  const fadeObserver = new IntersectionObserver((entries, obs) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        entry.target.classList.add("fade-in-visible");
        obs.unobserve(entry.target);
      }
    });
  }, { threshold: 0.2 });

  fadeEls.forEach(el => fadeObserver.observe(el));

});
</script>

<!-- ‚úÖ Hi·ªáu ·ª©ng fade-in -->
<style>
.fade-in {
  opacity: 0;
  transform: translateY(20px);
  transition: opacity 0.6s ease-out, transform 0.6s ease-out;
}
.fade-in-visible {
  opacity: 1;
  transform: translateY(0);
}
.col-span-2 {
  grid-column: span 2 / span 2;
}

</style>
