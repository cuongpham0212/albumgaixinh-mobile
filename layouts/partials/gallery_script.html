<script>
document.addEventListener("DOMContentLoaded", function () {
  if ("scrollRestoration" in history) history.scrollRestoration = "manual";

  const params = new URLSearchParams(window.location.search);
  const isUnlocked = params.get("unlock") === "1";

  const unlockBtn = document.getElementById("unlock-nude-btn");
  const overlay = document.getElementById("overlay-18plus");
  const countdownElem = overlay?.querySelector("#countdown");
  const confirmWrapper = overlay?.querySelector("#confirmWrapper");
  const adSection = overlay?.querySelector("#ad-section");
  const wrapper = document.getElementById("nude-gallery-wrapper");
  const sessionConfirmed = sessionStorage.getItem("adult_confirmed") === "true";

  // =====================================================
  // 🔹 Render gallery nude sau khi unlock
  // =====================================================
  function renderGallery() {
    const dataEl = document.querySelector('script[id^="nude-data-"]');
    if (!dataEl || !wrapper) return false;
    try {
      const json = JSON.parse(dataEl.textContent || "{}");
      if (!json || !Array.isArray(json.thumbs) || !Array.isArray(json.full)) return false;

      wrapper.innerHTML = `
        <h2 class="text-lg font-semibold mt-8 mb-3 text-center text-gray-800">
          Bộ ảnh nude (${json.thumbs.length} ảnh)
        </h2>
        <div class="grid grid-cols-2 gap-3 px-2">
          ${json.thumbs.map((thumb, i) => {
            const full = json.full[i] || thumb;
            return `
              <figure class="overflow-hidden rounded-lg shadow-md bg-white">
                <a href="${full}" class="block glightbox" data-gallery="gallery-nude">
                  <img src="${thumb}" class="w-full h-full object-cover transition-transform duration-300 hover:scale-105" loading="lazy" alt="Ảnh nude ${i+1}">
                </a>
              </figure>
            `;
          }).join("")}
        </div>
      `;

      initLightboxWithPinchZoom();

      // 🔽 Auto scroll xuống album nude sau khi load
      setTimeout(() => {
        wrapper.scrollIntoView({ behavior: "smooth", block: "start" });
      }, 800);

      return true;
    } catch (e) {
      console.error("❌ Lỗi parse JSON dữ liệu nude:", e);
      return false;
    }
  }

  // =====================================================
  // 🔹 Countdown quảng cáo + xác nhận 18+
  // =====================================================
  function startAdCountdown() {
    overlay.style.display = "flex";
    overlay.classList.add("fadeIn");

    if (!overlay.dataset.adLoaded) {
      overlay.dataset.adLoaded = "true";
      const script = document.createElement("script");
      script.src = "//pl27755613.revenuecpmgate.com/14/6a/67/146a67a2abc2c71f2e2e007b32802a2d.js";
      script.async = true;
      adSection?.appendChild(script);
    }

    let sec = 10;
    const timer = setInterval(() => {
      sec--;
      if (countdownElem) countdownElem.textContent = sec;
      if (sec <= 0) {
        clearInterval(timer);
        if (!sessionConfirmed) {
          showConfirmButton();
        } else {
          openGallery();
        }
      }
    }, 1000);
  }

  // =====================================================
  // 🔹 Nút xác nhận 18+
  // =====================================================
  function showConfirmButton() {
    confirmWrapper.innerHTML = `<button id="confirmBtn" class="mt-2 px-5 py-2 bg-gradient-to-r from-pink-600 to-red-600 text-white rounded-full shadow-md">Tôi đủ 18 tuổi, vào xem album 💋</button>`;
    const btn = document.getElementById("confirmBtn");
    btn.addEventListener("click", () => {
      sessionStorage.setItem("adult_confirmed", "true");
      openGallery();
    });
  }

  // =====================================================
  // 🔹 Mở gallery sau khi quảng cáo kết thúc
  // =====================================================
  function openGallery() {
    overlay.classList.remove("fadeIn");
    overlay.style.display = "none";
    const url = new URL(window.location.href);
    url.searchParams.set("unlock", "1");
    window.location.href = url.toString();
  }

  // =====================================================
  // 🔹 Nút mở album nude
  // =====================================================
  if (unlockBtn) {
    unlockBtn.addEventListener("click", function () {
      unlockBtn.disabled = true;
      unlockBtn.innerText = "⏳ Đang mở quảng cáo...";
      setTimeout(() => {
        startAdCountdown();
        unlockBtn.disabled = false;
        unlockBtn.innerText = "💋 Mở album nude (xem quảng cáo 10s)";
      }, 300);
    });
  }

  // =====================================================
  // 🔹 Khi có ?unlock=1 → render luôn album nude
  // =====================================================
  if (isUnlocked) {
    overlay?.setAttribute("style", "display:none;");
    renderGallery();
  }

  // =====================================================
  // 📸 Pinch Zoom mượt (giữ như cũ)
  // =====================================================
  function initLightboxWithPinchZoom() {
    if (typeof GLightbox === "undefined") return;
    const lightbox = GLightbox({
      selector: ".glightbox",
      touchNavigation: true,
      zoomable: true,
      loop: true,
      closeOnOutsideClick: false
    });
    setTimeout(() => {
      const imgs = document.querySelectorAll(".gslide-image img");
      imgs.forEach(img => attachPinchZoom(img));
    }, 600);
  }

  function attachPinchZoom(img) {
    let scale = 1, lastScale = 1, startX = 0, startY = 0, currentX = 0, currentY = 0;
    let active = false;
    const container = img.closest(".gslide-image");
    if (!container) return;

    container.addEventListener("touchstart", e => {
      if (e.touches.length === 2) {
        active = true; lastScale = scale;
      } else if (e.touches.length === 1 && scale > 1) {
        startX = e.touches[0].clientX - currentX;
        startY = e.touches[0].clientY - currentY;
      }
    }, { passive: true });

    container.addEventListener("touchmove", e => {
      if (!active) return;
      if (e.touches.length === 2) {
        const dx = e.touches[0].clientX - e.touches[1].clientX;
        const dy = e.touches[0].clientY - e.touches[1].clientY;
        const distance = Math.sqrt(dx * dx + dy * dy);
        if (!container._lastDistance) container._lastDistance = distance;
        const delta = distance / container._lastDistance;
        scale = Math.min(Math.max(lastScale * delta, 1), 4);
        img.style.transform = `scale(${scale}) translate(${currentX / scale}px, ${currentY / scale}px)`;
      } else if (e.touches.length === 1 && scale > 1) {
        currentX = e.touches[0].clientX - startX;
        currentY = e.touches[0].clientY - startY;
        img.style.transform = `scale(${scale}) translate(${currentX / scale}px, ${currentY / scale}px)`;
      }
    }, { passive: true });

    container.addEventListener("touchend", e => {
      if (scale <= 1.05) {
        scale = 1; currentX = currentY = 0;
        img.style.transform = "scale(1)";
      }
      container._lastDistance = null;
      active = false;
    });
  }

});
</script>
